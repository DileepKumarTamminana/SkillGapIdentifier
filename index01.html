import json
import boto3
from boto3.dynamodb.conditions import Key
from decimal import Decimal

dynamodb = boto3.resource("dynamodb")
table = dynamodb.Table("SkillGapHistory")

# Fix for Decimal serialization
def convert_decimal(obj):
    if isinstance(obj, list):
        return [convert_decimal(i) for i in obj]
    if isinstance(obj, dict):
        return {k: convert_decimal(v) for k, v in obj.items()}
    if isinstance(obj, Decimal):
        return int(obj) if obj % 1 == 0 else float(obj)
    return obj

def lambda_handler(event, context):
    try:
        body = json.loads(event.get("body", "{}"))

        employeeId = body.get("employeeId")
        roleId = body.get("roleId")  # optional

        if not employeeId:
            return {
                "statusCode": 400,
                "body": json.dumps({"message": "employeeId is required"})
            }

        # Query using GSI
        response = table.query(
            IndexName="skillgapIndex",
            KeyConditionExpression=Key("employeeId").eq(employeeId)
        )

        items = response.get("Items", [])

        # Optional filter by roleId
        if roleId:
            items = [i for i in items if i.get("roleId") == roleId]

        # Sort by timestamp DESC (latest first)
        items.sort(key=lambda x: x.get("timestamp", ""), reverse=True)

        # Return TOP 5 entries
        items = items[:5]

        return {
            "statusCode": 200,
            "headers": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Headers": "*",
                "Access-Control-Allow-Methods": "*"
            },
            "body": json.dumps(convert_decimal(items))
        }

    except Exception as e:
        return {
            "statusCode": 500,
            "body": json.dumps({
                "message": "Internal Server Error",
                "error": str(e)
            })
        }
