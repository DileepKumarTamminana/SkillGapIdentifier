<!DOCTYPE html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Skill Gap & Learning Management Portal</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <!-- Choices.js searchable dropdown -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <style>
        /* ---------- THEME VARIABLES ---------- */
        :root {
            --bg: #f4f5f9;
            --header-bg: linear-gradient(135deg, #0048ff, #0099ff);
            --header-text: #ffffff;
            --nav-bg: #ffffff;
            --nav-btn-bg: #e7e9f0;
            --nav-btn-active: #006aff;
            --nav-btn-active-text: #ffffff;
            --card-bg: #ffffff;
            --card-border: #ddd;
            --text: #000;
            --subtext: #444;
            --button-bg: #006aff;
            --button-hover: #004fcc;
            --progress-bg: #e5e7eb;
            --progress-text: #000;
            --progress-fill-gradient: linear-gradient(90deg, #00c853, #00e676);
            --border-color: #ddd;
        }

        .dark-mode {
            --bg: #181a1e;
            --header-bg: linear-gradient(135deg, #002a80, #0048cc);
            --header-text: #ffffff;
            --nav-bg: #1f2125;
            --nav-btn-bg: #2a2d33;
            --nav-btn-active: #006aff;
            --nav-btn-active-text: #ffffff;
            --card-bg: #24262b;
            --card-border: #3a3d42;
            --text: #e5e5e5;
            --subtext: #bbbbbb;
            --button-bg: #007bff;
            --button-hover: #005fcc;
            --progress-bg: #2f3237;
            --progress-text: #ffffff;
            --progress-fill-gradient: linear-gradient(90deg, #29b6f6, #00e5ff);
        }

        /* ---------- GLOBAL ---------- */
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: 0.3s ease;
        }

        /* ---------- HEADER ---------- */
        .header {
            background: var(--header-bg);
            padding: 16px 20px;
            color: var(--header-text);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            justify-content: center;
            position: relative;
            align-items: center;
        }

        .theme-toggle,
        .nav-toggle {
            position: absolute;
            top: 10px;
            background: transparent;
            border: none;
            color: var(--header-text);
            font-size: 20px;
            cursor: pointer;
        }

        .theme-toggle {
            right: 20px;
        }

        .nav-toggle {
            left: 20px;
        }

        /* Notification pill */
        .emp-notif-pill {
            position: absolute;
            right: 62px;
            top: 12px;
            background: #ffe08a;
            color: #7a5200;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            max-width: 260px;
            white-space: nowrap;
            overflow: hidden;
        }

        .dark-mode .emp-notif-pill {
            background: #424242;
            color: #ffd54f;
        }

        .emp-notif-pill.hidden {
            display: none;
        }

        /* ---------- LAYOUT ---------- */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* ---------- SIDE NAV ---------- */
        .nav {
            width: 250px;
            background: var(--nav-bg);
            padding: 20px 10px;
            transition: width 0.3s ease;
            box-shadow: 2px 0 6px rgba(0, 0, 0, 0.08);
        }

        .nav.collapsed {
            width: 70px;
        }

        .nav button {
            padding: 12px;
            width: 100%;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
            background: var(--nav-btn-bg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
            transition: 0.3s;
        }

        .nav button.active {
            background: var(--nav-btn-active);
            color: var(--nav-btn-active-text);
        }

        .nav.collapsed button span.label {
            opacity: 0;
        }

        /* ---------- CONTENT ---------- */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ---------- CARDS ---------- */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 18px;
        }

        /* ---------- BUTTONS ---------- */
        .primary-btn,
        .secondary-btn {
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .primary-btn {
            background: var(--button-bg);
            color: #fff;
        }

        .primary-btn:hover {
            background: var(--button-hover);
        }

        .secondary-btn {
            background: #e5e7eb;
        }

        .full-width {
            width: 100%;
            margin-top: 10px;
        }

        /* ---------- INPUTS ---------- */
        input,
        select,
        textarea {
            width: 100%;
            padding: 9px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            color: var(--text);
            margin-bottom: 10px;
        }

        input:focus,
        select:focus {
            outline: 2px solid var(--button-bg);
        }

        /* ---------- PROGRESS BAR ---------- */
        .progress-bar-container {
            background: var(--progress-bg);
            height: 16px;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0;
            background: var(--progress-fill-gradient);
            transition: width 0.8s ease;
            position: relative;
        }

        .progress-bar-fill::before {
            content: "";
            position: absolute;
            top: 0;
            left: -40%;
            width: 40%;
            height: 100%;
            background: linear-gradient(120deg,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0.6),
                    rgba(255, 255, 255, 0));
            animation: shine 1.8s infinite;
        }

        @keyframes shine {
            0% {
                left: -40%;
            }

            100% {
                left: 100%;
            }
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            transform: translateY(-50%);
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            color: var(--progress-text);
        }

        /* ---------- COLLAPSIBLES ---------- */
        .collapsible {
            cursor: pointer;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            font-weight: 700;
        }

        .collapse-content {
            display: none;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 0 0 10px 10px;
            border: 1px solid var(--border-color);
            border-top: none;
        }

        .collapse-active+.collapse-content {
            display: block;
        }

        /* ---------- RECOMMENDED COURSES TABLE ---------- */
        .rec-table-wrapper {
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
        }

        .rec-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .rec-table thead {
            background: linear-gradient(90deg, #006aff, #00a3ff);
            color: white;
        }

        .dark-mode .rec-table thead {
            background: linear-gradient(90deg, #024ac4, #0277bd);
        }

        .rec-table th,
        .rec-table td {
            padding: 10px 12px;
            text-align: left;
        }

        .rec-table tbody tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.03);
        }

        .dark-mode .rec-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }

        .rec-table tbody tr:hover {
            background: rgba(0, 106, 255, 0.12);
        }

        .rec-skill-pill {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(0, 106, 255, 0.15);
            color: #004fcf;
        }

        .dark-mode .rec-skill-pill {
            background: rgba(144, 202, 249, 0.2);
            color: #e3f2fd;
        }

        .rec-course-link {
            font-size: 12px;
            font-weight: 600;
            color: #006aff;
            text-decoration: none;
        }

        .rec-course-link:hover {
            text-decoration: underline;
        }

        .rec-course-link::before {
            content: "‚Üó ";
            font-size: 11px;
        }

        /* ---------- LOADER ---------- */
        /* ============================================================
   RECOMMENDED COURSES TABLE (Clean, Modern, Responsive)
   ============================================================ */

        .recommended-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--card-border);
        }

        .recommended-table th {
            background: var(--button-bg);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        .recommended-table td {
            padding: 10px;
            border-bottom: 1px solid var(--card-border);
        }

        .recommended-table tr:last-child td {
            border-bottom: none;
        }

        .recommended-table a {
            color: var(--nav-btn-active);
            font-weight: 600;
            text-decoration: none;
        }

        .recommended-table a:hover {
            text-decoration: underline;
        }


        /* ============================================================
   EXPIRING CERTIFICATIONS LIST
   ============================================================ */

        .expiry-entry {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .expiry-entry strong {
            font-size: 15px;
        }


        /* ============================================================
   TEAM SKILL GAP TRACKER TABLE
   ============================================================ */

        .team-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .team-table th,
        .team-table td {
            padding: 10px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }


        .team-table tr:last-child td {
            border-bottom: none;
        }


        /* ============================================================
   COLLAPSIBLE SECTIONS ‚Äî Smooth Transition
   ============================================================ */

        .collapsible {
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .collapsible:hover {
            background: rgba(0, 106, 255, 0.15);
        }

        .collapse-active {
            background: rgba(0, 106, 255, 0.25) !important;
            transform: scale(0.98);
        }


        /* ============================================================
   MANAGER REQUEST CARDS ‚Äî Clean layout
   ============================================================ */

        .entry button {
            margin-right: 6px;
        }

        .entry strong {
            font-size: 15px;
        }

        .entry {
            border-left: 4px solid var(--button-bg);
        }


        /* ============================================================
   DARK MODE OPTIMIZATION
   ============================================================ */

        .dark-mode .recommended-table th {
            background: #0077ff;
        }

        .dark-mode .recommended-table td {
            border-bottom: 1px solid #3d3f44;
        }

        .dark-mode .team-table th {
            background: #0077ff;
        }

        .dark-mode .team-table td {
            border-bottom: 1px solid #3d3f44;
        }

        .dark-mode .expiry-entry {
            border-color: #3d3f44;
        }

        /* ---------- HIDDEN CLASS ---------- */
        .hidden {
            display: none !important;
        }

        /* ---------- Choices.js DARK MODE FIXES ---------- */
        /* Fix placeholder color inside Choices dropdown */
        .dark-mode .choices__inner .choices__placeholder {
            color: #e0e0e0 !important;
            /* bright placeholder */
            opacity: 1 !important;
        }

        /* Fix selected text color */
        .dark-mode .choices__inner .choices__item--selectable {
            color: #ffffff !important;
        }

        /* Fix dropdown items text color */
        .dark-mode .choices__list--dropdown .choices__item {
            color: #ffffff !important;
            background: #2f3237 !important;
        }

        /* ================================
   FIX Choices.js in Dark Mode
   Make it match the normal select UI
   ================================ */

        /* Main input box */
        .dark-mode .choices__inner {
            background: var(--card-bg) !important;
            border: 1px solid var(--card-border) !important;
            color: var(--text) !important;
            border-radius: 8px !important;
            padding: 6px !important;
        }

        /* Placeholder text */
        .dark-mode .choices__inner .choices__placeholder {
            color: #bdbdbd !important;
            opacity: 1 !important;
        }

        /* Selected item text */
        .dark-mode .choices__inner .choices__item--selectable {
            color: var(--text) !important;
        }

        /* Dropdown panel */
        .dark-mode .choices__list--dropdown {
            background: var(--card-bg) !important;
            border: 1px solid var(--card-border) !important;
        }

        /* Dropdown option text */
        .dark-mode .choices__list--dropdown .choices__item {
            color: var(--text) !important;
            background: var(--card-bg) !important;
        }

        /* Hover state */
        .dark-mode .choices__list--dropdown .choices__item--selectable:hover {
            background: rgba(0, 106, 255, 0.2) !important;
            color: var(--text) !important;
        }

        /* Arrow icon color */
        .dark-mode .choices[data-type*=select-one]::after {
            border-color: var(--text) transparent transparent transparent !important;
        }

        /* ================================
   FIX Choices.js Search Box in Dark Mode
   ================================ */

        .dark-mode .choices__list--dropdown .choices__input {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border: 1px solid var(--card-border) !important;
            border-radius: 6px !important;
            padding: 8px !important;
        }

        /* Search input placeholder */
        .dark-mode .choices__list--dropdown .choices__input::placeholder {
            color: #bdbdbd !important;
        }

        /* Remove white highlight on focus */
        .dark-mode .choices__list--dropdown .choices__input:focus {
            outline: 2px solid var(--button-bg) !important;
        }

        /* ===========================================
   LABEL INSIDE SEARCH DROPDOWN FOR Choices.js
   =========================================== */

        .choices__list--dropdown::before {
            content: "Search";
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--subtext);
            padding: 6px 10px 2px 10px;
        }

        /* Dark mode label color */
        .dark-mode .choices__list--dropdown::before {
            color: #cccccc;
        }

        .card h3 {
            margin-bottom: 12px;
        }

        .card .primary-btn.full-width {
            display: block;
            margin-top: 8px;
        }

        .entry {
            background: var(--card-bg);
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--card-border);
        }
        /* Fix Team Skill Gap table spacing issue */
.team-table {
    width: 100%;
    border-collapse: collapse;
}

.team-table th,
.team-table td {
    padding: 10px;
    text-align: left;
}

.team-table tr {
    height: auto;
    line-height: normal;
}

.team-table tbody tr:hover {
    background: rgba(0, 106, 255, 0.08);
}
/* Make "Select Employee" (Choices.js) look like normal select */

/* Wrapper behaves like normal input */
.choices {
    width: 100%;
    margin-bottom: 10px;
}

/* Main box */
.choices__inner {
    background: var(--card-bg) !important;
    border: 1px solid var(--card-border) !important;
    border-radius: 8px !important;
    padding: 9px 12px !important;
    min-height: 42px !important;
    box-shadow: none !important;
    font-size: 14px;
}

/* Selected text */
.choices__list--single .choices__item {
    padding: 0 !important;
    margin: 0 !important;
}

/* Dropdown arrow to match normal select */
.choices[data-type*='select-one']::after {
    border-color: #666 transparent transparent transparent !important;
    right: 12px;
}

/* Dark mode arrow + text */
.dark-mode .choices[data-type*='select-one']::after {
    border-color: #e0e0e0 transparent transparent transparent !important;
}
.dark-mode .choices__inner {
    background: var(--card-bg) !important;
    border-color: var(--card-border) !important;
}


    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <button class="nav-toggle" onclick="toggleNav()">‚ò∞</button>
        AI Skill Gap & Learning Management Portal

        <!-- Notification pill (learned skills approval/reject status) -->
        <div id="empStatusNotification" class="emp-notif-pill hidden">
            No updates
        </div>

        <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
    </div>

    <div class="container">

        <!-- SIDE NAV -->
        <div class="nav" id="sideNav">
            <button class="active" onclick="switchView('employee')">
                <span class="icon">üë§</span>
                <span class="label">Employee View</span>
            </button>
            <button onclick="switchView('manager')">
                <span class="icon">üßë‚Äçüíº</span>
                <span class="label">Manager View</span>
            </button>
        </div>

        <!-- MAIN CONTENT -->
        <!-- <div class="content"> -->

        <!-- ================= EMPLOYEE VIEW ================= -->
        <!-- <div id="employeeView">  -->

        <div class="content" id="employeePage">
            <div id="employeeView">

                <!-- 1. Employee & Role Selection -->
                <div class="card">
                    <h3>1. Employee & Role Selection</h3>

                    <label>Select Employee</label>
                    <select id="employeeId" onchange="showEmployeeProfile()">
                        <option value="">Loading employees...</option>
                    </select>

                    <label>Select Target Role</label>
                    <select id="roleId">
                        <option value="">Loading roles...</option>
                    </select>

                    <button class="primary-btn full-width" onclick="checkSkillGap()">Analyze Skill Gap</button>

                    <div id="employeeProfile" style="margin-top:12px;"></div>
                </div>

                <!-- 2. Skill Gap Analysis -->
                <div class="card">
                    <h3>2. Skill Gap Analysis</h3>
                    <div id="skillGapOutput"></div>
                    <div style="margin-top:10px;">
                        <button class="primary-btn" onclick="exportCSV()">Export CSV</button>
                        <button class="secondary-btn" onclick="exportPDF()">Export PDF</button>
                    </div>
                    <!-- Skill chart is optional; canvas can be re-enabled if needed
                    <div style="margin-top:15px;">
                        <h4 style="margin:0 0 8px;">Skill Distribution</h4>
                        <canvas id="skillChart" height="130"></canvas>
                    </div>
                    -->
                </div>

                <!-- 3. Skill Gap History -->
                <div class="card">
                    <h3>3. Skill Gap History</h3>
                    <button class="primary-btn full-width" onclick="loadHistory()">View History</button>
                    <div id="historyOutput" style="margin-top:12px;"></div>
                </div>

                <!-- 4. Request Addition of Learned Skill (collapsible) -->
                <div class="card">
                    <h3>4. Request Addition of Learned Skill</h3>
                    <button class="primary-btn full-width" onclick="toggleSection(this)">Add Learning</button>
                    <div class="collapse-content">

                        <label>Employee</label>
                        <div class="dropdown-with-icon">
                            <select id="skillReqEmployee">
                                <option value="">Loading employees...</option>
                            </select>
                        </div>

                        <label>Skill Name</label>
                        <input id="reqSkillName" placeholder="e.g. Docker" />

                        <label>Certification Name (Optional)</label>
                        <input id="reqCertName" placeholder="e.g. Docker Certified Associate" />

                        <label>Certification Expiry (Optional)</label>
                        <input id="reqExpiryDate" type="date" />

                        <button class="primary-btn full-width" onclick="requestSkill()">Submit Request</button>

                        <div id="skillReqResult" style="margin-top:10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MANAGER VIEW ================= -->

        <!-- <div id="managerView" class="hidden"> -->
        <div class="content hidden" id="managerPage">
            <div id="managerView">

                <!-- 1. Pending Skill Approval Requests -->
                <div class="card">
                    <h3>1. Pending Skill Approval Requests</h3>
                    <button class="primary-btn full-width" onclick="loadPendingRequests()">Refresh Pending
                        Requests</button>
                    <div id="pendingRequestsBox" style="margin-top:12px;"></div>
                </div>

                <!-- 2. Expiring Certifications -->
                <div class="card">
                    <h3>2. Expiring Certifications (Next 90 Days)</h3>
                    <button class="primary-btn full-width" onclick="loadExpiringSkills()">Load Expiring</button>
                    <div id="expiringSkillsBox" style="margin-top:12px;"></div>
                    <!-- Optional chart:
                    <div style="margin-top:15px;">
                        <h4 style="margin:0 0 8px;">Expiring by Month</h4>
                        <canvas id="expiryChart" height="130"></canvas>
                    </div>
                    -->
                </div>

                <!-- 3. Team Skill Gap Tracker -->
                <div class="card">
                    <h3>3. Team Skill Gap Tracker</h3>
                    <button class="primary-btn full-width" onclick="runTeamSkillGap()">Run Skill Gap for
                        Team</button>
                    <div id="team-table-wrapper" style="margin-top:12px;"></div>
                </div>

                <!-- 4. Assign Learning to Team (collapsible) -->
                <div class="card">
                    <h3>4. Assign Learning to Team</h3>
                    <button class="primary-btn full-width" onclick="toggleSection(this)">Assign Learning</button>
                    <div class="collapse-content">
                        <label>Select Employee</label>
                        <select id="assignEmployee"></select>

                        <label>Skill Name</label>
                        <input id="assignSkillName" />

                        <label>Course Name</label>
                        <input id="assignCourseName" />

                        <label>Due Date</label>
                        <input id="assignDueDate" type="date" />

                        <button class="primary-btn full-width" onclick="assignLearning()">Submit</button>
                        <div id="assignResultBox" style="margin-top:10px;"></div>
                    </div>
                </div>

                <!-- 5. Manage Employees & Target Roles (collapsible) -->
                <div class="card">
                    <h3>5. Manage Employees & Target Roles</h3>
                    <button class="primary-btn full-width" onclick="toggleSection(this)">Manage Employees</button>
                    <div class="collapse-content">
                        <button class="primary-btn full-width" onclick="loadManagerEmployees()">Load
                            Employees</button>
                        <div id="managerEmployeesBox" style="margin-top:12px;"></div>

                        <hr style="margin:16px 0;">

                        <h4>Add New Employee</h4>
                        <label>Employee ID</label>
                        <input id="newEmpId" placeholder="E004" />
                        <label>Name</label>
                        <input id="newEmpName" placeholder="New Employee" />
                        <label>Current Role</label>
                        <input id="newEmpRole" placeholder="Developer" />
                        <label>Target Role (Role ID)</label>
                        <input id="newEmpTargetRole" placeholder="R004" />
                        <button class="primary-btn full-width" onclick="createEmployee()">Submit</button>
                        <div id="newEmpResult" style="margin-top:10px;"></div>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- /container -->

    <!-- JS will be added in Part 3 -->
    <script>
        // placeholder - Part 3 will replace this tag
    </script>

</body>
<script>
    /* =============================== */
    /*           CONFIG                */
    /* =============================== */

    const API_BASE = "https://dx87uzkcm2.execute-api.us-east-1.amazonaws.com";

    let employeesList = [];
    let rolesList = [];
    let lastSkillGapResult = null;

    let empChoices, skillReqChoices, assignChoices;

    /* =============================== */
    /*        INITIAL LOAD             */
    /* =============================== */
    window.onload = () => {
        loadEmployees();
        loadRoles();
        setMinDates();

        // Restore theme
        if (localStorage.getItem("theme") === "dark") {
            document.body.classList.add("dark-mode");
        }
    };

    /* =============================== */
    /*        THEME & NAV              */
    /* =============================== */

    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem(
            "theme",
            document.body.classList.contains("dark-mode") ? "dark" : "light"
        );
    }

    function toggleNav() {
        document.getElementById("sideNav").classList.toggle("collapsed");
    }

    // Switch between Employee and Manager views
    function switchView(view) {
        const empPage = document.getElementById("employeePage");
        const mgrPage = document.getElementById("managerPage");

        // Switch page visibility
        empPage.classList.add("hidden");
        mgrPage.classList.add("hidden");

        if (view === "employee") {
            empPage.classList.remove("hidden");
            empPage.scrollTop = 0;   // reset scroll
        } else {
            mgrPage.classList.remove("hidden");
            mgrPage.scrollTop = 0;   // reset scroll
        }

        // Update active nav button
        const navButtons = document.querySelectorAll(".nav button");
        navButtons.forEach(btn => btn.classList.remove("active"));
        navButtons[view === "employee" ? 0 : 1].classList.add("active");
    }


    /* =============================== */
    /*      LOAD EMPLOYEES             */
    /* =============================== */

    async function loadEmployees() {
        const selects = ["employeeId", "skillReqEmployee", "assignEmployee"];

        selects.forEach(id => {
            const sel = document.getElementById(id);
            sel.innerHTML = `<option>Loading...</option>`;
        });

        try {
            const res = await fetch(`${API_BASE}/employees`);
            const list = await res.json();
            employeesList = list;

            selects.forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = `<option value="">-- Select Employee --</option>`;
            });

            list.forEach(emp => {
                const label = `${emp.employeeId} - ${emp.name}`;
                selects.forEach(id => {
                    document.getElementById(id).innerHTML += `<option value="${emp.employeeId}">${label}</option>`;
                });
            });

            // Enable searchable dropdowns
            initChoices();

        } catch (err) {
            console.error(err);
        }
    }

    /* =============================== */
    /*  SEARCHABLE DROPDOWNS (Choices) */
    /* =============================== */

    function initChoices() {
        if (empChoices) empChoices.destroy();
        if (skillReqChoices) skillReqChoices.destroy();
        if (assignChoices) assignChoices.destroy();

        empChoices = new Choices("#employeeId", { searchEnabled: true, shouldSort: false });
        skillReqChoices = new Choices("#skillReqEmployee", { searchEnabled: true, shouldSort: false });
        assignChoices = new Choices("#assignEmployee", { searchEnabled: true, shouldSort: false });
    }

    /* =============================== */
    /*           LOAD ROLES            */
    /* =============================== */

    async function loadRoles() {
        const sel = document.getElementById("roleId");
        sel.innerHTML = `<option>Loading...</option>`;

        try {
            const res = await fetch(`${API_BASE}/roles`);
            const list = await res.json();
            rolesList = list;

            sel.innerHTML = `<option value="">-- Select Role --</option>`;
            list.forEach(r => {
                sel.innerHTML += `<option value="${r.roleId}">${r.roleId} - ${r.roleName}</option>`;
            });
        } catch (err) {
            console.error(err);
        }
    }

    /* =============================== */
    /*     SHOW EMPLOYEE PROFILE       */
    /* =============================== */

    function showEmployeeProfile() {
        const empId = document.getElementById("employeeId").value;
        const box = document.getElementById("employeeProfile");

        if (!empId) {
            box.innerHTML = "Select an employee to view details.";
            return;
        }

        const emp = employeesList.find(e => e.employeeId === empId);

        const skills = emp.skills || [];
        const certs = emp.certifications || [];

        // Auto-select stored target role
        if (emp.targetRoleId) {
            document.getElementById("roleId").value = emp.targetRoleId;
        }

        box.innerHTML = `
        <strong>Name:</strong> ${emp.name}<br>
        <strong>Current Role:</strong> ${emp.currentRole}<br>
        <strong>Skills:</strong> ${skills.join(", ") || "None"}<br>
        <strong>Certifications:</strong><br>
        ${certs.length
                ? certs.map(c => `- ${c.skill} (${c.certificationName}) (Expiry: ${c.expiryDate})<br>`).join("")
                : "None"
            }
    `;

        loadEmployeeNotification(empId);
    }

    /* =============================== */
    /*       SKILL GAP ANALYSIS        */
    /* =============================== */

    async function checkSkillGap() {
        const employeeId = document.getElementById("employeeId").value;
        const roleId = document.getElementById("roleId").value;
        const out = document.getElementById("skillGapOutput");

        if (!employeeId || !roleId) {
            out.innerHTML = `<p style="color:red;">Select both employee and role.</p>`;
            return;
        }

        out.innerHTML = `<div class='loader'></div>Analyzing...`;

        try {
            const res = await fetch(`${API_BASE}/skill-gap`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ employeeId, roleId })
            });

            const data = await res.json();

            const matched = data.matchedSkills;
            const missing = data.missingSkills;
            const percent = data.matchPercent;

            lastSkillGapResult = data;

            out.innerHTML = `
            <p><strong>Employee:</strong> ${data.employeeName}</p>
            <p><strong>Role:</strong> ${data.roleName}</p>
            <p><strong>Match:</strong> ${percent}%</p>

            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="gapProgressFill">
                    <span class="progress-text" id="gapProgressText">0%</span>
                </div>
            </div>

            <br><strong>Matched Skills:</strong> ${matched.join(", ") || "None"}
            <br><br><strong>Missing Skills:</strong> ${missing.join(", ") || "None"}
            <br><br><strong>Recommended Courses:</strong>
            ${data.recommendedCourses.length
                    ? `
                    <table class="recommended-table">
                        <tr><th>Skill</th><th>Course</th><th>Link</th></tr>
                        ${data.recommendedCourses.map(c => `
                                <tr>
                                    <td>${c.skill}</td>
                                    <td>${c.courseName}</td>
                                    <td><a href="${c.courseLink}" target="_blank">Open</a></td>
                                </tr>
                            `).join("")
                    }
                    </table>
                `
                    : "No recommendations."
                }
        `;

            // Progress animation
            setTimeout(() => {
                document.getElementById("gapProgressFill").style.width = percent + "%";
                document.getElementById("gapProgressText").textContent = percent + "%";
            }, 150);

        } catch (err) {
            out.innerHTML = `<p style="color:red;">Error running analysis.</p>`;
            console.error(err);
        }
    }

    /* =============================== */
    /*           HISTORY               */
    /* =============================== */

    async function loadHistory() {
        const employeeId = document.getElementById("employeeId").value;
        const roleId = document.getElementById("roleId").value;
        const box = document.getElementById("historyOutput");

        if (!employeeId) {
            box.innerHTML = `<p style="color:red;">Select an employee.</p>`;
            return;
        }

        box.innerHTML = `<div class="loader"></div>Loading...`;

        try {
            const res = await fetch(`${API_BASE}/history`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ employeeId, roleId })
            });

            let data = await res.json();

            if (data.body) data = JSON.parse(data.body);

            if (!data.length) {
                box.innerHTML = "No history found.";
                return;
            }

            box.innerHTML = data.map(h => `
            <div class="entry">
                <strong>Role:</strong> ${h.roleId}<br>
                <strong>Match:</strong> ${h.matchPercent}%<br>
                <strong>Missing:</strong> ${h.missingSkills.join(", ")}<br>
                <small>${h.timestamp}</small>
            </div>
        `).join("");

        } catch (err) {
            box.innerHTML = `<p style="color:red;">Error loading history.</p>`;
        }
    }

    /* =============================== */
    /*      REQUEST LEARNED SKILL      */
    /* =============================== */

    async function requestSkill() {
        const empId = document.getElementById("skillReqEmployee").value;
        const skill = document.getElementById("reqSkillName").value.trim();
        const cert = document.getElementById("reqCertName").value.trim();
        let expiry = document.getElementById("reqExpiryDate").value.trim();
        const box = document.getElementById("skillReqResult");

        if (!empId || !skill) {
            box.innerHTML = `<p style="color:red;">Employee & Skill are required.</p>`;
            return;
        }

        if (expiry && expiry.includes("-")) {
            const parts = expiry.split("-");
            if (parts[0].length !== 4) {
                box.innerHTML = `<p style="color:red;">Use YYYY-MM-DD format.</p>`;
                return;
            }
        }

        box.innerHTML = `<div class="loader"></div>Submitting...`;

        try {
            const res = await fetch(`${API_BASE}/request-skill`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    employeeId: empId,
                    skillName: skill,
                    certificationName: cert,
                    expiryDate: expiry || null
                })
            });

            const data = await res.json();

            if (res.status === 200) {
                box.innerHTML = `<p style="color:green;">Request submitted.</p>`;
            } else {
                box.innerHTML = `<p style="color:red;">${data.message}</p>`;
            }
        } catch (err) {
            box.innerHTML = `<p style="color:red;">Error submitting.</p>`;
        }
    }

    /* =============================== */
    /*       PENDING REQUESTS          */
    /* =============================== */

    async function loadPendingRequests() {
        const box = document.getElementById("pendingRequestsBox");
        box.innerHTML = `<div class='loader'></div>Loading...`;

        try {
            const res = await fetch(`${API_BASE}/pending-requests`);
            let data = await res.json();
            if (data.body) data = JSON.parse(data.body);

            if (!data.length) {
                box.innerHTML = "No pending requests.";
                return;
            }

box.innerHTML = data.map(r => `
    <div class="entry">
        <strong>${r.employeeName || "Unknown"} (${r.employeeId})</strong> 
        requested <strong>${r.skillName}</strong><br>
        
        Certification: ${r.certificationName || "N/A"}<br>
        Expiry: ${r.expiryDate || "N/A"}<br>

        <button class="primary-btn" onclick="approveSkill('${r.requestId}','APPROVE')">Approve</button>
        <button class="secondary-btn" onclick="approveSkill('${r.requestId}','REJECT')">Reject</button>
    </div>
`).join("");


        } catch (err) {
            box.innerHTML = `<p style="color:red;">Error loading requests.</p>`;
        }
    }

    async function approveSkill(id, action) {
        const box = document.getElementById("pendingRequestsBox");

        try {
            const res = await fetch(`${API_BASE}/approve-skill`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ requestId: id, action, managerId: "MANAGER1" })
            });

            const data = await res.json();

            if (res.status === 200) {
                box.innerHTML = `<p style="color:green;">${data.message}</p>`;
                loadPendingRequests();
            } else {
                box.innerHTML = `<p style="color:red;">${data.message}</p>`;
            }
        } catch (err) {
            box.innerHTML = `<p style="color:red;">Error approving.</p>`;
        }
    }

    /* =============================== */
    /*     EXPIRING CERTIFICATIONS     */
    /* =============================== */

    async function loadExpiringSkills() {
        const box = document.getElementById("expiringSkillsBox");
        box.innerHTML = `<div class='loader'></div>Checking...`;

        try {
            const res = await fetch(`${API_BASE}/expiring-skills`);
            let data = await res.json();
            if (data.body) data = JSON.parse(data.body);

            if (!data.length) {
                box.innerHTML = "No expiring certifications.";
                return;
            }

            box.innerHTML = data.map(e => `
            <div class="entry">
                <strong>${e.employeeName} (${e.employeeId})</strong><br>
                Skill: ${e.skill}<br>
                Certification: ${e.certificationName}<br>
                Expiry: ${e.expiryDate}
            </div>
        `).join("");

        } catch (err) {
            box.innerHTML = `<p style="color:red;">Error loading expiring certs.</p>`;
        }
    }

    /* =============================== */
    /*     TEAM SKILL GAP TRACKER      */
    /* =============================== */

async function runTeamSkillGap() {
    const box = document.getElementById("team-table-wrapper");

    console.log("RUN BUTTON CLICKED");   // DEBUG-1

    box.innerHTML = `<div class="loader"></div>Running...`;

    try {
        console.log("Employees List:", employeesList);   // DEBUG-2

        if (!employeesList || employeesList.length === 0) {
            box.innerHTML = `<p style="color:red;">No employees loaded. employeesList is EMPTY.</p>`;
            return;
        }

        let rows = [];

        for (const emp of employeesList) {
            console.log("Processing employee:", emp);    // DEBUG-3

            if (!emp.targetRoleId) {
                console.log("Skipping employee (No targetRoleId):", emp.employeeId);
                continue;
            }

            let data = null;

            try {
                const res = await fetch(`${API_BASE}/skill-gap`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        employeeId: emp.employeeId,
                        roleId: emp.targetRoleId
                    })
                });

                data = await res.json();
                console.log("Skill Gap API result:", data); // DEBUG-4

            } catch (innerErr) {
                console.error("API fetch failed:", innerErr);
                continue;
            }

            if (!data || !data.matchPercent || !data.missingSkills) {
                rows.push({
                    employeeId: emp.employeeId,
                    name: emp.name,
                    roleId: emp.targetRoleId,
                    roleName: emp.currentRole || "Unknown",
                    match: "N/A",
                    missing: "N/A"
                });
                continue;
            }

            rows.push({
                employeeId: emp.employeeId,
                name: emp.name,
                roleId: emp.targetRoleId,
                roleName: data.roleName || emp.currentRole || "Unknown",
                match: data.matchPercent,
                missing: data.missingSkills.length
            });
        }

        console.log("Final rows:", rows);   // DEBUG-5

        if (rows.length === 0) {
            box.innerHTML = `<p style="color:red;">No data generated. Something is missing.</p>`;
            return;
        }

        rows.sort((a, b) => (a.roleId > b.roleId ? 1 : -1));

        box.innerHTML = `
        <div class="team-table-wrapper">
            <table class="team-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Role ID</th>
                        <th>Role Name</th>
                        <th>Match %</th>
                        <th>Missing</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(r => `
                        <tr>
                            <td>${r.employeeId} - ${r.name}</td>
                            <td>${r.roleId}</td>
                            <td>${r.roleName}</td>
                            <td>${r.match}</td>
                            <td>${r.missing}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        </div>`;
        
    } catch (err) {
        console.error("Team Skill Gap Error:", err);
        box.innerHTML = `<p style="color:red;">Error running team analysis.</p>`;
    }
}


    /* =============================== */
    /*         ASSIGN LEARNING         */
    /* =============================== */

    async function assignLearning() {
        const emp = document.getElementById("assignEmployee").value;
        const skill = document.getElementById("assignSkillName").value.trim();
        const course = document.getElementById("assignCourseName").value.trim();
        const due = document.getElementById("assignDueDate").value;
        const box = document.getElementById("assignResultBox");

        if (!emp || !skill || !course) {
            box.innerHTML = `<p style="color:red;">All fields required.</p>`;
            return;
        }

        box.innerHTML = `<div class="loader"></div>Assigning...`;

        try {
            const res = await fetch(`${API_BASE}/assign-learning`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    employeeId: emp,
                    skillName: skill,
                    courseName: course,
                    dueDate: due,
                    managerId: "MANAGER1"
                })
            });

            const data = await res.json();

            if (res.status === 200) {
                box.innerHTML = `<p style="color:green;">Assigned successfully.</p>`;
            } else {
                box.innerHTML = `<p style="color:red;">${data.message}</p>`;
            }

        } catch (err) {
            box.innerHTML = `<p style="color:red;">Error assigning.</p>`;
        }
    }

    /* =============================== */
    /*       MANAGE EMPLOYEES          */
    /* =============================== */

    async function loadManagerEmployees() {
        const box = document.getElementById("managerEmployeesBox");
        box.innerHTML = `<div class="loader"></div>Loading...`;

        try {
            const res = await fetch(`${API_BASE}/employees`);
            const data = await res.json();
            employeesList = data;

            const { nextEmpId, nextRoleId } = generateIds();

            document.getElementById("newEmpId").value = nextEmpId;
            document.getElementById("newEmpId").readOnly = true;

            document.getElementById("newEmpTargetRole").value = nextRoleId;
            document.getElementById("newEmpTargetRole").readOnly = true;

            box.innerHTML = data.map(emp => `
            <div class="entry">
                <strong>${emp.employeeId}</strong> - ${emp.name}<br>
                Current Role: ${emp.currentRole}<br>
                Target Role:
                <select id="mgr_${emp.employeeId}">
                    ${rolesList.map(r => `
                            <option value="${r.roleId}" ${r.roleId === emp.targetRoleId ? "selected" : ""}>
                                ${r.roleId} - ${r.roleName}
                            </option>
                        `).join("")
                }
                </select>
                <button class="primary-btn" onclick="updateEmployeeRole('${emp.employeeId}')">Save</button>
            </div>
        `).join("");

        } catch (err) {
            box.innerHTML = `<p style="color:red;">Error loading employees.</p>`;
        }
    }

    async function updateEmployeeRole(empId) {
        const roleId = document.getElementById(`mgr_${empId}`).value;
        const box = document.getElementById("managerEmployeesBox");

        try {
            const res = await fetch(`${API_BASE}/update-employee-role`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ employeeId: empId, targetRoleId: roleId })
            });

            const data = await res.json();
            if (res.status === 200) {
                box.insertAdjacentHTML("afterbegin", `<p style="color:green;">Updated ${empId} ‚Üí ${roleId}</p>`);
            } else {
                box.insertAdjacentHTML("afterbegin", `<p style="color:red;">${data.message}</p>`);
            }
        } catch (err) {
            box.insertAdjacentHTML("afterbegin", `<p style="color:red;">Error updating.</p>`);
        }
    }

    /* =============================== */
    /*      AUTO-GENERATE IDs          */
    /* =============================== */

    function generateIds() {
        if (!employeesList.length) return { nextEmpId: "E001", nextRoleId: "R001" };

        const nums = employeesList.map(e => Number(e.employeeId.replace("E", "")));
        const next = Math.max(...nums) + 1;

        return {
            nextEmpId: "E" + String(next).padStart(3, "0"),
            nextRoleId: "R" + String(next).padStart(3, "0")
        };
    }

    /* =============================== */
    /*       DATE RESTRICTION          */
    /* =============================== */

    function setMinDates() {
        const today = new Date().toISOString().split("T")[0];
        document.querySelectorAll("input[type='date']").forEach(i => i.min = today);
    }

    /* =============================== */
    /*   NOTIFICATION PILL (TOP BAR)   */
    /* =============================== */

    async function loadEmployeeNotification(employeeId) {
        const pill = document.getElementById("empStatusNotification");

        try {
            const res = await fetch(`${API_BASE}/employee-requests-status`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ employeeId })
            });

            const data = await res.json();

            if (data.approved || data.rejected) {
                pill.textContent = `Approved: ${data.approved}, Rejected: ${data.rejected}`;
                pill.classList.remove("hidden");
            } else {
                pill.textContent = "No updates on learned skills.";
                pill.classList.remove("hidden");
            }

        } catch (err) {
            pill.textContent = "Unable to fetch notifications";
            pill.classList.remove("hidden");
        }
    }

    /* =============================== */
    /*        COLLAPSIBLE SECTIONS     */
    /* =============================== */

    function toggleSection(button) {
        button.classList.toggle("collapse-active");
    }
</script>

</html>