<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Skill Gap & Learning Management Portal</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <!-- Choices.js searchable dropdown -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

    <style>
        /********************************
        ========== THEME VARS ==========
        ********************************/
        :root {
            --bg: #f4f5f9;
            --header-bg: linear-gradient(135deg, #0048ff, #0099ff);
            --header-text: #ffffff;
            --card-bg: #ffffff;
            --card-border: #ddd;
            --text: #000;
            --subtext: #444;
            --button-bg: #006aff;
            --button-hover: #004fcc;
            --progress-bg: #e5e7eb;
        }

        .dark-mode {
            --bg: #181a1e;
            --header-bg: linear-gradient(135deg, #002a80, #0048cc);
            --header-text: #ffffff;
            --card-bg: #24262b;
            --card-border: #3a3d42;
            --text: #e5e5e5;
            --subtext: #bbbbbb;
            --button-bg: #007bff;
            --button-hover: #005fcc;
            --progress-bg: #2f3237;
        }

        /********************************
        ========== GLOBAL ==========
        ********************************/
        body {
            margin: 0;
            font-family: Segoe UI, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .hidden {
            display: none !important;
        }

        /********************************
        ========== HEADER ==========
        ********************************/
        .header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 16px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            right: 15px;
            top: 12px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 18px;
        }

        /********************************
        ========== LAYOUT ==========
        ********************************/
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .nav {
            width: 230px;
            background: #ffffff;
            padding: 18px;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.08);
        }

        .nav button {
            display: block;
            width: 100%;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: #e8e8e8;
            font-weight: 600;
        }

        .nav button.active {
            background: var(--button-bg);
            color: #fff;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /********************************
        ========== CARDS ==========
        ********************************/
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px 18px;
            margin-bottom: 20px;
        }

        .card h3 {
            margin-bottom: 14px;
        }

        /********************************
        ========== BUTTONS ==========
        ********************************/
        .primary-btn {
            background: var(--button-bg);
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            border: none;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
        }

        .primary-btn:hover {
            background: var(--button-hover);
        }

        .secondary-btn {
            background: #ddd;
            padding: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        /********************************
        ========== INPUTS ==========
        ********************************/
        select,
        input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text);
        }

        /********************************
        ===== SKILL GAP HISTORY CSS =====
        ********************************/

        .history-container {
            margin-top: 12px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            border-radius: 10px;
            padding: 14px;
            display: flex;
            justify-content: space-between;
            transition: 0.2s ease;
        }

        .history-item.highlight {
            border-left: 5px solid #006aff;
            background: rgba(0, 106, 255, 0.08);
        }

        .history-title {
            font-weight: 700;
            margin-bottom: 6px;
        }

        .match-badge {
            padding: 6px 10px;
            background: var(--progress-bg);
            border-radius: 999px;
            font-weight: 700;
            display: inline-block;
        }

        .star-btn {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 20px;
        }

        .delete-btn {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 18px;
            color: red;
        }

        /********************************
        ========== COLLAPSIBLE ==========
        ********************************/
        .collapsible-btn {
            width: 100%;
            background: var(--button-bg);
            color: white;
            padding: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .collapse-content {
            display: none;
            padding: 10px;
            border-radius: 10px;
        }

        .collapse-content.active {
            display: block;
        }
    </style>
</head>

<body>

    <!-------------------------------->
    <!--         HEADER              -->
    <!-------------------------------->
    <div class="header">
        AI Skill Gap & Learning Management Portal
        <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
    </div>

    <div class="container">

        <!-------------------------------->
        <!--        SIDE NAV             -->
        <!-------------------------------->
        <div class="nav">
            <button class="active" onclick="switchView('employee')">Employee View</button>
            <button onclick="switchView('manager')">Manager View</button>
        </div>

        <!-------------------------------->
        <!--         EMPLOYEE PAGE       -->
        <!-------------------------------->
        <div class="content" id="employeePage">

            <!-- 1. Employee & Role Selection -->
            <div class="card">
                <h3>1. Employee & Role Selection</h3>

                <label>Select Employee</label>
                <select id="employeeId"></select>

                <label>Select Target Role</label>
                <select id="roleId"></select>

                <button class="primary-btn" onclick="checkSkillGap()">Analyze Skill Gap</button>

                <div id="employeeProfile"></div>
            </div>

            <!-- 2. Skill Gap Analysis -->
            <div class="card">
                <h3>2. Skill Gap Analysis</h3>
                <div id="skillGapOutput"></div>

                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="primary-btn" onclick="exportCSV()">Export CSV</button>
                    <button class="secondary-btn" onclick="exportPDF()">Export PDF</button>
                </div>
            </div>

            <!-- 3. Skill Gap History -->
            <div class="card">
                <h3>3. Skill Gap History</h3>

                <button class="primary-btn" onclick="toggleHistory()">View History</button>

                <div id="historySection" class="history-container hidden">
                    <div id="historyTools" class="hidden">
                        <button class="secondary-btn" onclick="downloadHistory()">Download CSV</button>
                    </div>

                    <div class="history-list" id="historyOutput"></div>

                    <div id="historyPager" class="hidden"></div>
                </div>
            </div>

            <!-- 4. Request Skill -->
            <div class="card">
                <h3>4. Request Addition of Learned Skill</h3>

                <button class="collapsible-btn" onclick="toggleSection(this)">Add Learning</button>

                <div class="collapse-content">
                    <label>Employee</label>
                    <select id="skillReqEmployee"></select>

                    <label>Skill Name</label>
                    <input id="reqSkillName" />

                    <label>Certification Name (Optional)</label>
                    <input id="reqCertName" />

                    <label>Certification Expiry</label>
                    <input type="date" id="reqExpiryDate" />

                    <button class="primary-btn" onclick="requestSkill()">Submit</button>

                    <div id="skillReqResult"></div>
                </div>
            </div>

        </div>

        <!-------------------------------->
        <!--         MANAGER PAGE        -->
        <!-------------------------------->
        <div class="content hidden" id="managerPage">

            <div class="card">
                <h3>1. Pending Skill Approval</h3>
                <button class="primary-btn" onclick="loadPendingRequests()">Refresh</button>
                <div id="pendingRequestsBox"></div>
            </div>

            <div class="card">
                <h3>2. Expiring Certifications</h3>
                <button class="primary-btn" onclick="loadExpiringSkills()">Load</button>
                <div id="expiringSkillsBox"></div>
            </div>

            <div class="card">
                <h3>3. Team Skill Gap</h3>
                <button class="primary-btn" onclick="runTeamSkillGap()">Run</button>
                <div id="team-table-wrapper"></div>
            </div>

            <div class="card">
                <h3>4. Assign Learning</h3>

                <button class="collapsible-btn" onclick="toggleSection(this)">Assign Learning</button>

                <div class="collapse-content">
                    <label>Select Employee</label>
                    <select id="assignEmployee"></select>

                    <label>Skill Name</label>
                    <input id="assignSkillName" />

                    <label>Course Name</label>
                    <input id="assignCourseName" />

                    <label>Due Date</label>
                    <input type="date" id="assignDueDate" />

                    <button class="primary-btn" onclick="assignLearning()">Submit</button>

                    <div id="assignResultBox"></div>
                </div>
            </div>

        </div>

    </div>
</body>

<script>
/* ===========================================
   CONFIG
=========================================== */

const API_BASE = "https://dx87uzkcm2.execute-api.us-east-1.amazonaws.com";

/* API Routes */
const API_getEmployees = `${API_BASE}/employees`;
const API_getRoles = `${API_BASE}/roles`;
const API_skillGap = `${API_BASE}/skill-gap`;
const API_getHistory = `${API_BASE}/history`;
const API_deleteHistory = `${API_BASE}/history/delete`;
const API_toggleFavorite = `${API_BASE}/history/favorite`;
const API_exportHistory = `${API_BASE}/history/export`;

let employeesList = [];
let rolesList = [];

let historyPageLimit = 5;
let fullHistory = [];   // All logs sorted
let currentPage = 1;

/* ===========================================
   INITIAL LOAD
=========================================== */
window.onload = () => {
    loadEmployees();
    loadRoles();

    // Restore theme
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
    }
};

/* ===========================================
   THEME
=========================================== */
function toggleTheme() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme",
        document.body.classList.contains("dark-mode")
            ? "dark"
            : "light"
    );
}

/* ===========================================
   NAV / PAGE SWITCHING
=========================================== */
function switchView(view) {
    document.getElementById("employeePage").classList.add("hidden");
    document.getElementById("managerPage").classList.add("hidden");

    if (view === "employee") {
        document.getElementById("employeePage").classList.remove("hidden");
    } else {
        document.getElementById("managerPage").classList.remove("hidden");
    }

    document.querySelectorAll(".nav button")
        .forEach(btn => btn.classList.remove("active"));

    document.querySelectorAll(".nav button")[view === "employee" ? 0 : 1]
        .classList.add("active");
}

/* ===========================================
   LOAD EMPLOYEES
=========================================== */
async function loadEmployees() {
    const sel1 = document.getElementById("employeeId");
    const sel2 = document.getElementById("skillReqEmployee");
    const sel3 = document.getElementById("assignEmployee");

    [sel1, sel2, sel3].forEach(s => s.innerHTML = `<option>Loading...</option>`);

    try {
        const res = await fetch(API_getEmployees);
        employeesList = await res.json();

        [sel1, sel2, sel3].forEach(s => {
            s.innerHTML = `<option value="">-- Select --</option>`;
        });

        employeesList.forEach(e => {
            const label = `${e.employeeId} - ${e.name}`;
            sel1.innerHTML += `<option value="${e.employeeId}">${label}</option>`;
            sel2.innerHTML += `<option value="${e.employeeId}">${label}</option>`;
            sel3.innerHTML += `<option value="${e.employeeId}">${label}</option>`;
        });

    } catch (e) {
        console.error("Employees load error", e);
    }
}

/* ===========================================
   LOAD ROLES
=========================================== */
async function loadRoles() {
    const sel = document.getElementById("roleId");
    sel.innerHTML = `<option>Loading...</option>`;

    try {
        const res = await fetch(API_getRoles);
        rolesList = await res.json();

        sel.innerHTML = `<option value="">-- Select Role --</option>`;
        rolesList.forEach(r => {
            sel.innerHTML += `<option value="${r.roleId}">${r.roleId} - ${r.roleName}</option>`;
        });

    } catch (e) {
        console.error("Roles load error", e);
    }
}

/* ===========================================
   SHOW EMPLOYEE PROFILE
=========================================== */
function showEmployeeProfile() {
    const id = document.getElementById("employeeId").value;
    const out = document.getElementById("employeeProfile");

    if (!id) return (out.innerHTML = "Select employee");

    const emp = employeesList.find(x => x.employeeId === id);
    const skills = emp.skills || [];
    const certs = emp.certifications || [];

    out.innerHTML = `
        <strong>Name:</strong> ${emp.name}<br>
        <strong>Current Role:</strong> ${emp.currentRole}<br>
        <strong>Skills:</strong> ${skills.join(", ") || "None"}<br><br>

        <strong>Certifications:</strong><br>
        ${(certs.length
            ? certs.map(c => `‚Ä¢ ${c.skill} (${c.certificationName}) - Exp: ${c.expiryDate}<br>`).join("")
            : "None")}
    `;
}

/* ===========================================
   SKILL GAP ANALYSIS
=========================================== */
async function checkSkillGap() {
    const emp = document.getElementById("employeeId").value;
    const role = document.getElementById("roleId").value;
    const out = document.getElementById("skillGapOutput");

    if (!emp || !role) {
        out.innerHTML = `<p style="color:red">Select employee + role</p>`;
        return;
    }

    out.innerHTML = "Analyzing...";

    try {
        const res = await fetch(API_skillGap, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ employeeId: emp, roleId: role })
        });

        const data = await res.json();
        renderSkillGap(data);

    } catch (e) {
        out.innerHTML = `<p style="color:red">Error</p>`;
    }
}

function renderSkillGap(data) {
    const out = document.getElementById("skillGapOutput");

    out.innerHTML = `
        <strong>Employee:</strong> ${data.employeeName}<br>
        <strong>Role:</strong> ${data.roleName}<br>
        <strong>Match:</strong> ${data.matchPercent}%<br><br>

        <strong>Matched:</strong> ${data.matchedSkills.join(", ") || "None"}<br>
        <strong>Missing:</strong> ${data.missingSkills.join(", ") || "None"}<br><br>

        <strong>Recommended Courses:</strong><br>
        ${data.recommendedCourses.length
            ? data.recommendedCourses.map(c => `
                ‚Ä¢ <strong>${c.skill}</strong>: 
                ${c.courseName} 
                <a href="${c.courseLink}" target="_blank">Open</a>
              `).join("<br>")
            : "None"}
    `;
}

/* ===========================================
   HISTORY ‚Äî EXPAND/COLLAPSE
=========================================== */
function toggleHistory() {
    const section = document.getElementById("historySection");
    const visible = !section.classList.contains("hidden");

    if (visible) {
        section.classList.add("hidden");
    } else {
        section.classList.remove("hidden");
        loadHistory();
    }
}

/* ===========================================
   LOAD HISTORY (Full + Favorite + Current)
=========================================== */
async function loadHistory() {
    const emp = document.getElementById("employeeId").value;
    if (!emp) return alert("Select employee");

    const out = document.getElementById("historyOutput");
    out.innerHTML = "Loading...";

    try {
        const res = await fetch(API_getHistory, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ employeeId: emp })
        });

        const data = await res.json();

        // FULL SORTED LIST
        fullHistory = [...data.favoriteLogs, ...data.otherLogs].sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        currentPage = 1;
        renderHistoryPage();

    } catch (e) {
        out.innerHTML = `<p style="color:red">Error loading history</p>`;
    }
}

/* ===========================================
   PAGINATION LOGIC
=========================================== */
function getPagedHistory() {
    const start = (currentPage - 1) * historyPageLimit;
    return fullHistory.slice(start, start + historyPageLimit);
}

function renderHistoryPage() {
    const out = document.getElementById("historyOutput");
    const pager = document.getElementById("historyPager");
    const tools = document.getElementById("historyTools");

    tools.classList.remove("hidden");

    const items = getPagedHistory();
    if (!items.length) {
        out.innerHTML = "No logs found";
        pager.innerHTML = "";
        return;
    }

    out.innerHTML = items.map((h, idx) => `
        <div class="history-item ${idx === 0 && currentPage === 1 ? "highlight" : ""}">
            
            <div>
                <div class="history-title">${h.roleId}</div>
                <div class="match-badge">${safePercent(h.matchPercent)}%</div>
                <div><strong>Missing:</strong> ${h.missingSkills.join(", ")}</div>
                <div><strong>Date:</strong> ${h.timestamp.split("T")[0]}</div>
            </div>

            <div style="text-align:right;">
                <button class="star-btn"
                    onclick="toggleFavorite('${h.historyId}', ${h.favorite})">
                    ${h.favorite ? "‚≠ê" : "‚òÜ"}
                </button>

                <button class="delete-btn" 
                    onclick="deleteHistory('${h.historyId}')">üóë</button>
            </div>
        </div>
    `).join("");

    const totalPages = Math.ceil(fullHistory.length / historyPageLimit);

    pager.innerHTML = `
        <div style="margin-top:10px; text-align:center;">
            <button onclick="prevPage()" ${currentPage === 1 ? "disabled" : ""}>Prev</button>
            <span style="margin:0 10px;">Page ${currentPage} / ${totalPages}</span>
            <button onclick="nextPage()" ${currentPage === totalPages ? "disabled" : ""}>Next</button>
        </div>
    `;
}

function nextPage() {
    const totalPages = Math.ceil(fullHistory.length / historyPageLimit);
    if (currentPage < totalPages) {
        currentPage++;
        renderHistoryPage();
    }
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderHistoryPage();
    }
}

/* ===========================================
   FAVORITE TOGGLE
=========================================== */
async function toggleFavorite(id, current) {
    await fetch(API_toggleFavorite, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ historyId: id, favorite: !current })
    });

    loadHistory();
}

/* ===========================================
   DELETE HISTORY
=========================================== */
async function deleteHistory(id) {
    if (!confirm("Delete this history log permanently?")) return;

    await fetch(API_deleteHistory, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ historyId: id })
    });

    loadHistory();
}

/* ===========================================
   CSV DOWNLOAD
=========================================== */
async function downloadHistory() {
    const emp = document.getElementById("employeeId").value;
    if (!emp) return alert("Select employee");

    const res = await fetch(API_exportHistory, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ employeeId: emp })
    });

    const csv = await res.text();
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `history-${emp}.csv`;
    a.click();

    URL.revokeObjectURL(url);
}

/* ===========================================
   SAFE PERCENT
=========================================== */
function safePercent(v) {
    if (v === null || v === undefined) return 0;
    return isNaN(Number(v)) ? 0 : Number(v);
}

/* ===========================================
   COLLAPSIBLE
=========================================== */
function toggleSection(btn) {
    const content = btn.nextElementSibling;
    content.classList.toggle("active");
}

</script>


</html>

